name: Scraping & Analysis CI

on:
  push:
    branches: [ main, task-* ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1. Checkout repository
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 2. Setup Python
      # -------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"  # or your project version

      # -------------------------
      # 3. Install dependencies
      # -------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------------------------------
      # 4. Download NLTK Data & SpaCy model
      # -------------------------------------------------
      - name: Install NLTK & SpaCy models
        run: |
          python - <<EOF
          import nltk
          nltk.download('punkt')
          nltk.download('punkt_tab')      # NEW
          nltk.download('stopwords')
          nltk.download('vader_lexicon')
          EOF

          python -m spacy download en_core_web_sm

      # -------------------------------------------------
      # 5. Run Unit Tests (if available)
      # -------------------------------------------------
      - name: Run Tests
        run: |
          if [ -d "tests" ]; then
            pytest --maxfail=1 --disable-warnings -q
          else
            echo "No tests folder found. Skipping tests."
          fi

      # -------------------------------------------------
      # 6. Run notebook (Analysis.ipynb)
      # -------------------------------------------------
      - name: Run Jupyter Notebook
        run: |
          pip install jupyter nbconvert
          jupyter nbconvert --execute --inplace notebooks/analysis.ipynb
        continue-on-error: true  # Prevent workflow failure if analysis notebook error

      # -------------------------------------------------
      # 7. Upload outputs (CSV, reports, etc.)
      # -------------------------------------------------
      - name: Upload Generated Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraping-analysis-results
          path: outputs/*.csv
